# CWMIN Disassembly (C64 Super-Forth)

This directory contains a reproducible disassembly of the `CWMIN` PRG from the CW Boot disk image, plus a rebuild verification that confirms the disassembled output can be reassembled into a byte-identical PRG.

## What this contains

- `cwmin.asm`: Disassembly output with code/data separation and labels for code targets.
- `cwmin.report.json`: SHA-256 hashes, byte counts, and a `match` flag verifying identical rebuild output.
- `cwmin-asm-notes.md`: Notes correlating Super-Forth source screens with the CWMIN disassembly.

The extraction output (`CWMIN.prg`) and rebuilt PRG (`cwmin.rebuilt.prg`) are generated by the script and intentionally left untracked.

## Reproduce the disassembly + rebuild

From the repository root:

```bash
./scripts/disasm-cwmin.sh
```

This script performs:

1. PRG extraction using the emulator's D64 loader (`go run ./cmd/extract-d64` in `c64/emulator`).
2. Disassembly + rebuild + hash verification (`scripts/cwmin_disasm.py`).

If the rebuild does not match, the script exits non-zero.

## Disassembly methodology

The disassembler (`scripts/cwmin_disasm.py`) performs a two-phase analysis:

1. **Control-flow pass**
   - Parses the BASIC header at `$0801`, locating the `SYS 2064` entry point (`$0810`).
   - Recursively disassembles from known entry points, following `JSR`, `JMP`, and branch targets.
   - Stops linear sweep on `RTS`, `RTI`, `BRK`, and indirect jumps.
   - Prevents overlapping instruction decoding to avoid false positives.

2. **Heuristic discovery pass**
   - Scans the remaining data for 16-bit addresses that point back into the PRG payload.
   - Treats candidate targets as code only when the bytes decode into plausible 6502 instruction sequences.

The output annotates code and data separately:

- Code is rendered as 6502 mnemonics with operand formats that preserve addressing mode.
- Data runs are emitted as `.text` for printable ASCII strings and `.byte` for binary data.

## Verification results

The latest run produced a byte-for-byte match between the original and rebuilt PRG. See `cwmin.report.json` for hashes and summary counts.

## Notes on FORTH structure

`CWMIN` is a ChipWits-customized Super-Forth environment. In addition to conventional 6502 machine code, it contains extensive FORTH threaded code and data tables. The disassembler separates these based on control-flow reachability plus address-table heuristics, but FORTH parameter fields are still emitted as data (`.byte`/`.text`) for fidelity.
